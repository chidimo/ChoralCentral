{% extends "choralcentral_base.html" %}
{% block title %}Search songs{% endblock title %}
{% block introduction %}{% endblock introduction %}

{% load static %}
{% load blog_ttags %}

{% block content_content %}

    <!-- search box -->
    <div class="row search-input-box">
        <div class="col-sm-12">
            <input id="q" name="q" placeholder="Type to find songs" autocomplete="off" autocorrect="false" spellcheck="false" class="form-control" type="search">
        </div>
    </div>
    <!-- end search box -->

    <div class="row search-info-box">
        <div class="col-sm-12" id="hits-stat"></div>
    </div>

    <div class="row search-info-box">
        <div class="col-sm-12 d-none" id="no-hits"></div>
    </div>

    <div id="hits-container"></div>

{% endblock content_content %}


{% block javascript %}
<script src="//cdn.jsdelivr.net/hogan.js/3.0.2/hogan.min.js"></script>
    {% verbatim %}
        <script type="text/template" id="hit-template">
            <div class="list-songs">

                <a href="{{ get_absolute_url }}">
                    <h3>{{{ _highlightResult.title.value }}}</h3>
                </a>

                <p>{{{ _highlightResult.all_authors.value }}}</p>
                <p>{{{ _highlightResult.all_seasons.value }}}</p>
                <p>{{{ _highlightResult.all_masspart.value }}}</p>
                <p>{{{ _highlightResult.lyrics.value }}}</p>
            </div>
        </script>
    {% endverbatim %}

<script>
$(document).ready(function() {
    var $inputField = $('#q');
    var $hitsContainer = $('#hits-container');
    var $noHits = $('#no-hits');
    var $hitsStat = $('#hits-stat');
    var hitTemplate = Hogan.compile($('#hit-template').text());

    var client = algoliasearch('{{ appID }}', '{{ searchKey }}');
    var helper = algoliasearchHelper(client, '{{ indexName }}');

    $('.search-terms a').click(function(e) {
        $inputField.val($(this).text()).change().focus();
        $inputField.keyup();
    });

    $inputField.on('keyup', function() {
        var query = $inputField.val();
        helper.setQuery(query).search();
    }).focus();

    helper.on('result', function(data) {
    renderHits(data);
    });

    helper.search(); // first search

    function renderHits(content) {
    var hitsHtml = '';

    if (content.hits.length === 0) {
        hitsHtml = '<p class="text-center text-danger lead">We didn\'t find any results for your search.</p>';
        $noHits.html(hitsHtml);
        $noHits.removeClass('d-none');
        $hitsContainer.addClass('d-none');
    } else {
        for (var i = 0; i < content.hits.length; ++i) {
        hitsHtml += hitTemplate.render(content.hits[i]);
        }

        $hitsContainer.html(hitsHtml);
        $hitsContainer.removeClass('d-none');
        $noHits.addClass('d-none');
    }

    $hitsStat.html('<p class="text-right">Found <b>' +
        content.nbHits + '</b> results in <b>' + content.processingTimeMS + '</b>ms ' +
        '<br>Search powered by <a href="http://www.algolia.com" target="_blank"><img src="{% static "img/logo-algolia.png" %}" /></a></p>'
    );
    }
});
</script>
{% endblock %}
